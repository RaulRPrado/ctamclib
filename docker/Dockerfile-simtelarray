FROM almalinux:9.2 as build_image
WORKDIR /workdir
ENV DEBIAN_FRONTEND=noninteractive

RUN yum install -y \
    bash \
    csh \
    gcc \
    gcc-c++ \
    gfortran \
    gsl-devel \
    krb5-workstation \
    make \
    unzip \
    wget \
    yum clean all && rm -rf /var/cache/yum

RUN mkdir sim_telarray
COPY corsika7.7_simtelarray.tar.gz sim_telarray/
RUN cd sim_telarray && \
    tar -xvf corsika7.7_simtelarray.tar.gz && \
    ./build_all prod5 qgs2 gsl && \
    find . -name "*.tar.gz" -exec rm -f {} \; && \
    cd ..

FROM almalinux:9.2
WORKDIR /workdir
ENV DEBIAN_FRONTEND=noninteractive

COPY --from=build_image /workdir/sim_telarray/ /workdir/sim_telarray/

RUN yum install -y \
    bc \
    gcc \
    gcc-c++ \
    gfortran \
    gsl-devel \
    unzip \
    zstd && \
    yum clean all && rm -rf /var/cache/yum

ENV SIMTEL_PATH="/workdir/sim_telarray/"

SHELL ["/bin/bash", "-c"]
WORKDIR /workdir/
