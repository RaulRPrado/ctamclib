

<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Developer Guidelines &#8212; simtools v0.1.dev1+gc0bc562 Manual</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/bizstyle.css" />
    
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Simulation Software" href="simulation_software.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="simulation_software.html" title="Simulation Software"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">simtools v0.1.dev1+gc0bc562 Manual</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Developer Guidelines</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="developer-guidelines">
<span id="guidelines"></span><h1>Developer Guidelines<a class="headerlink" href="#developer-guidelines" title="Permalink to this heading">¶</a></h1>
<p>This section provides help and guidelines for developers of simtools.
If you want to contribute to simtools, please use one of the contact points listed at the
entry page of this documentation. In general, please take note of the <a class="reference external" href="https://cta-observatory.github.io/ctapipe/development/index.html">ctapipe Development
Guidelines</a>. simtools
follows the same <a class="reference external" href="https://cta-observatory.github.io/ctapipe/development/style-guide.html#">style</a>
and <a class="reference external" href="https://cta-observatory.github.io/ctapipe/development/code-guidelines.html">code guidelines</a>
as <a class="reference external" href="https://github.com/cta-observatory/ctapipe/">ctapipe</a>.</p>
<section id="project-setup">
<h2>Project setup<a class="headerlink" href="#project-setup" title="Permalink to this heading">¶</a></h2>
<p>The main code repository for simtools is on GitHub:</p>
<p><a class="reference external" href="https://github.com/gammasim/simtools">https://github.com/gammasim/simtools</a></p>
<p>The main directories for developers are the
<a class="reference external" href="https://github.com/gammasim/simtools/tree/main/simtools">simtools</a>,
<a class="reference external" href="https://github.com/gammasim/simtools/tree/main/applications">applications</a>,
<a class="reference external" href="https://github.com/gammasim/simtools/tree/main/tests">tests</a>,
and <a class="reference external" href="https://github.com/gammasim/simtools/tree/main/docs">docs</a> folders.</p>
</section>
<section id="python-version">
<h2>Python version<a class="headerlink" href="#python-version" title="Permalink to this heading">¶</a></h2>
<p>The simtools package is currently developed for Python 3.9.</p>
</section>
<section id="code-formatting">
<h2>Code formatting<a class="headerlink" href="#code-formatting" title="Permalink to this heading">¶</a></h2>
<p>Linting and code checks are done automatically using the pre-commit functionality using <code class="docutils literal notranslate"><span class="pre">isort</span></code>,
<code class="docutils literal notranslate"><span class="pre">black</span></code> and <code class="docutils literal notranslate"><span class="pre">pyflakes</span></code>. As part of the CI workflow Codacy performs a few additional code checks
as well.</p>
<p>It is recommended for developers to install <code class="docutils literal notranslate"><span class="pre">pre-commit</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pre</span><span class="o">-</span><span class="n">commit</span> <span class="n">install</span>
</pre></div>
</div>
<p>The configuration of <code class="docutils literal notranslate"><span class="pre">pre-commit</span></code> is defined in
<a class="reference external" href="https://github.com/gammasim/simtools/blob/main/.pre-commit-config.yaml">.pre-commit-config.yaml</a>.</p>
<p>For testing, pre-commit can be applied locally without commit:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pre</span><span class="o">-</span><span class="n">commit</span> <span class="n">run</span> <span class="o">--</span><span class="nb">all</span><span class="o">-</span><span class="n">files</span>
</pre></div>
</div>
<p>In rare cases, one might want to skip pre-commit checks with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">commit</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">verify</span>
</pre></div>
</div>
</section>
<section id="logging">
<h2>Logging<a class="headerlink" href="#logging" title="Permalink to this heading">¶</a></h2>
<p>Sufficient logging information should be provided to users and developers. As general guideline, the
following logging levels should be used:</p>
<ul class="simple">
<li><p><strong>INFO</strong>: information useful for the general user about the progress, intermediate results, input or output.</p></li>
<li><p><strong>WARNING</strong>: information for the general user or developer on something they should know but cannot change.</p></li>
<li><p><strong>DEBUG</strong>: information only interesting for developers or useful for debugging.</p></li>
<li><p><strong>ERROR</strong>: something which always leads to an exception or program exit.</p></li>
</ul>
<p>Use <code class="docutils literal notranslate"><span class="pre">logger.error,</span> <span class="pre">logger.warning,</span> <span class="pre">logger.debug,</span> <span class="pre">logger.info</span></code>.</p>
</section>
<section id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Permalink to this heading">¶</a></h2>
<p>pytest framework is used for unit testing.
The test modules are located in
<a class="reference external" href="https://github.com/gammasim/simtools/tree/main/tests">simtools/tests</a> modules separated
by unit and integration tests.
Every module should have a reasonable unit test, ideally all functions should be covered by tests.
Applications should be tested using integration tests.
It is important to write the tests in parallel with the modules
to assure that the code is testable.</p>
<p>General service functions for tests (e.g., DB connection) can be found in
<a class="reference external" href="https://github.com/gammasim/simtools/blob/main/tests/conftest.py">conftest.py</a>.
This should be used to avoid duplication.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Developers should expect that code changes affecting several modules are acceptable in case unit tests are successful.</p>
</div>
</section>
<section id="documentation">
<h2>Documentation<a class="headerlink" href="#documentation" title="Permalink to this heading">¶</a></h2>
<p>Sphinx is used to create this documentation from the files in the
<a class="reference external" href="https://github.com/gammasim/simtools/tree/main/docs">docs</a> directory and from the
docstrings in the code.
This is done automatically with each merge into the main branch, see the
<a class="reference external" href="https://github.com/gammasim/simtools/blob/main/.github/workflows/CI-docs.yml">GitHub Action workflow CI-docs</a>.</p>
<p>Docstrings following the Numpy style must be added to any public function, class or method.
It is also recommended to add docstrings-like comments to private functions.</p>
<p>In the application, the modules should contain docstrings with a general description, command line
parameters, and examples.
A typical example should look like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">a_function</span><span class="p">(</span><span class="n">parameter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description of what the function is doing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parameter: type</span>
<span class="sd">        description of parameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    describe return values</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    describe exceptions raised</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="o">...</span><span class="n">code</span>
</pre></div>
</div>
<p>For a reference of the numpydoc format, see <a class="reference external" href="https://numpydoc.readthedocs.io/en/latest/format.html">https://numpydoc.readthedocs.io/en/latest/format.html</a></p>
<p>For writing and testing documentation locally:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">docs</span>
<span class="n">make</span> <span class="n">html</span>
</pre></div>
</div>
<p>This is especially recommended to identify warnings and errors by Sphinx (e.g., from badly formatted
docstrings or RST files). The documentation can be viewed locally in a browser starting from the
file <code class="docutils literal notranslate"><span class="pre">./build/html/index.html</span></code>.</p>
</section>
<section id="writing-applications">
<h2>Writing Applications<a class="headerlink" href="#writing-applications" title="Permalink to this heading">¶</a></h2>
<p>Applications are command lines tools that should be built off of the simtools library.
Application should not include complex algorithm, this should be done at the module level.</p>
<p>All applications should follow the same structure:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="c1"># application name</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
    <span class="c1"># short description of the application</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;....&quot;</span>
    <span class="c1"># short help on how to use the application</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s2">&quot;.....&quot;</span>

    <span class="c1"># configuration handling (from command line, config file, etc)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="n">args_dict</span><span class="p">,</span> <span class="n">db_dict</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

    <span class="c1"># generic logger</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">get_log_level_from_user</span><span class="p">(</span><span class="n">args_dict</span><span class="p">[</span><span class="s2">&quot;log_level&quot;</span><span class="p">]))</span>

    <span class="c1"># application code follows</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Application handling should be done using the <a class="reference internal" href="configuration_module.html#configurationconfigurator"><span class="std std-ref">Configurator</span></a> class, which allows to set
configurations from command line, configuration file, or environmental variables.
Check the <a class="reference internal" href="configuration_module.html#configurationcommandline-parser"><span class="std std-ref">commandline_parser</span></a> module for generic command line arguments before introducing new ones in applications</p>
</section>
<section id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this heading">¶</a></h2>
<p>Dependencies on python packages are listed in the
<a class="reference external" href="https://github.com/gammasim/simtools/blob/main/environment.yml">environment file</a>.
Some of the packages installed are used for the development only and not needed for executing
simtools applications.</p>
</section>
<section id="integration-with-corsika-and-sim-telarray">
<h2>Integration with CORSIKA and sim_telarray<a class="headerlink" href="#integration-with-corsika-and-sim-telarray" title="Permalink to this heading">¶</a></h2>
<p>CORSIKA and sim_telarray are external tools to simtools.
Their integration should be
minimally coupled with the rest of the package. The modules that depend directly on these
tools should be connected to the rest of the package through interfaces. This way, it
will be easier to replace these tools in the future.</p>
<p>One example of this approach is
<a class="reference external" href="https://github.com/gammasim/simtools/blob/main/simtools/simulator.py">simulator module</a>,
which connects to the tools used to manage and run simulations.</p>
</section>
<section id="handling-data-files">
<h2>Handling data files<a class="headerlink" href="#handling-data-files" title="Permalink to this heading">¶</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Requires review</p>
</div>
<p>Data files should be kept outside of the simtools repository.
Some auxiliary files can be found in the
<a class="reference external" href="https://github.com/gammasim/simtools/tree/main/data">data directory</a>.
Note that this is under review and might go away in near future.</p>
</section>
<section id="naming">
<h2>Naming<a class="headerlink" href="#naming" title="Permalink to this heading">¶</a></h2>
<section id="telescope-names">
<h3>Telescope Names<a class="headerlink" href="#telescope-names" title="Permalink to this heading">¶</a></h3>
<p>The telescope names as used by simtools follow the pattern “Site-Class-Type”, where:</p>
<ul class="simple">
<li><p>“Site” is either “North” or “South”;</p></li>
<li><p>“Class” is either “LST”, “MST”, “SCT” or “SST”;</p></li>
<li><p>“Type” is a single number ONLY in case of a real telescope existing at the site or a string containing a “D” in case of any other telescope design.</p></li>
</ul>
<p>For example:</p>
<ul class="simple">
<li><p>“North-LST-1” is the first LST commissioned at the La Palma site, while “North-LST-D234” is the current design of the further 3 LSTs.</p></li>
<li><p>“North-MST-FlashCam-D” and “North-MST-NectarCam-D” are the two MST designs containing different cameras.</p></li>
</ul>
<p>Any input telescope names can (and should) be validated by the function validate_telescope_name
(see module <span class="xref std std-ref">util.names</span>).
For the Site field, any different capitalization (e.g “south”) or site names like “paranal” and
“lapalma” will be accepted
and converted to the standard ones. The same applies to the Class field.
For the Type field, any string will be accepted and a selected list of variations will be converted
to the standard ones
(e.g “flashcam” will be converted to “FlashCam”).</p>
</section>
<section id="validating-names">
<h3>Validating names<a class="headerlink" href="#validating-names" title="Permalink to this heading">¶</a></h3>
<p>Names that are recurrently used along the the package should be validated when given as input.
Examples of names are: telescope, site, camera, model version. The functionalities to validate names
are found in  <span class="xref std std-ref">util.names</span>. The function validate_name receives the input string
and a name dictionary,
that is usually called all_something_names. This dictionary contain the possible names (as keys) and
lists
of allowed alternatives names as values. In case the input name is found in one of the lists, the
key
is returned.</p>
<p>The name dictionaries are also defined in util.names. One should also define specific functions
named
validate_something_names that call the validate_name with the proper name dictionary. This is only
meant to
provide a clear interface.</p>
<p>This is an example of a name dictionary:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">all_site_names</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;South&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;paranal&quot;</span><span class="p">,</span> <span class="s2">&quot;south&quot;</span><span class="p">],</span>
  <span class="s2">&quot;North&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;lapalma&quot;</span><span class="p">,</span> <span class="s2">&quot;north&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And this is an example of how the site name is validated in the <a class="reference internal" href="mc_model.html#id4"><span class="std std-ref">telescope_model</span></a> module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">site</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">validate_site_name</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
</pre></div>
</div>
<p>where site was given as parameter to the <code class="docutils literal notranslate"><span class="pre">TelescopeModel::__init__</span></code> function.</p>
</section>
</section>
<section id="input-validation">
<h2>Input validation<a class="headerlink" href="#input-validation" title="Permalink to this heading">¶</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Requires review</p>
</div>
<p>Any module that receives configurable inputs (e.g. physical parameters)
must have them validated. The validation assures that the units, type and
format are correct and also allow for default values.</p>
<p>The configurable input must be passed to classes through a dictionary or a yaml
file. In the case of a dictionary the parameter is called config_data, and in the
case of a yaml file, config_file. See the ray_tracing module for an example.</p>
<p>The function gen.collect_data_from_yaml_or_dict(config_data, config_file, allow_empty=False)
must be used to read these arguments. It identifies which case was given and
reads it accordingly, returning a dictionary. It also raises an exception in case none are
given and not allow_empty.</p>
<p>The validation of the input is done by the function gen.validate_config_data, which
receives the dictionary with the collected input and a parameter dictionary. The parameter
dictionary is read from a parameter yaml file in the data/parameters directory.
The file is read through the function io.get_data_file(“parameters”, filename)
(see data files section).</p>
<p>The parameter yaml file contains the list of parameters to be validated and its
properties. See an example below:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">zenith_angle</span><span class="p">:</span>
<span class="w">  </span><span class="nt">len</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="kt">!astropy.units.Unit</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="nv">deg</span><span class="p p-Indicator">}</span>
<span class="w">  </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="kt">!astropy.units.Quantity</span>
<span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span>
<span class="w">    </span><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="kt">!astropy.units.Unit</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="nv">deg</span><span class="p p-Indicator">}</span>
<span class="w">  </span><span class="nt">names</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;zenith&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;theta&#39;</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>len gives the length of the input. If null, any len is accepted.</p></li>
<li><p>unit is the astropy unit</p></li>
<li><p>default must have the same len</p></li>
<li><p>names is a list of acceptable input names. The key in the returned dict will have the name given at the definition of the block (zenith_angle in this example)</p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="index.html">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="simtools-configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="library.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="auxiliary_files.html">Auxiliary Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="databases.html">Databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="simulation_software.html">Simulation Software</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Developer Guidelines</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#project-setup">Project setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#python-version">Python version</a></li>
<li class="toctree-l2"><a class="reference internal" href="#code-formatting">Code formatting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#logging">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="#testing">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#documentation">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#writing-applications">Writing Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="#integration-with-corsika-and-sim-telarray">Integration with CORSIKA and sim_telarray</a></li>
<li class="toctree-l2"><a class="reference internal" href="#handling-data-files">Handling data files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#naming">Naming</a></li>
<li class="toctree-l2"><a class="reference internal" href="#input-validation">Input validation</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/guidelines.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="simulation_software.html" title="Simulation Software"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">simtools v0.1.dev1+gc0bc562 Manual</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Developer Guidelines</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, gammasim-tools, simtools developers.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 6.2.1.
    </div>
  </body>
</html>