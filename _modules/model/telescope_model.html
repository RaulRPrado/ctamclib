

<!doctype html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>model.telescope_model &#8212; simtools v0.1.dev1+g8f3402d Manual</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/bizstyle.css?v=532c1bf3" />
    
    <script src="../../_static/documentation_options.js?v=de617994"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">simtools v0.1.dev1+g8f3402d Manual</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">model.telescope_model</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for model.telescope_model</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">pydoc</span> <span class="kn">import</span> <span class="n">locate</span>

<span class="kn">import</span> <span class="nn">astropy.io.ascii</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>

<span class="kn">import</span> <span class="nn">simtools.utils.general</span> <span class="k">as</span> <span class="nn">gen</span>
<span class="kn">from</span> <span class="nn">simtools</span> <span class="kn">import</span> <span class="n">db_handler</span><span class="p">,</span> <span class="n">io_handler</span>
<span class="kn">from</span> <span class="nn">simtools.model.camera</span> <span class="kn">import</span> <span class="n">Camera</span>
<span class="kn">from</span> <span class="nn">simtools.model.mirrors</span> <span class="kn">import</span> <span class="n">Mirrors</span>
<span class="kn">from</span> <span class="nn">simtools.simtel.simtel_config_writer</span> <span class="kn">import</span> <span class="n">SimtelConfigWriter</span>
<span class="kn">from</span> <span class="nn">simtools.utils</span> <span class="kn">import</span> <span class="n">names</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;InvalidParameter&quot;</span><span class="p">,</span> <span class="s2">&quot;TelescopeModel&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="InvalidParameter">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.InvalidParameter">[docs]</a>
<span class="k">class</span> <span class="nc">InvalidParameter</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception for invalid parameter.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="TelescopeModel">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel">[docs]</a>
<span class="k">class</span> <span class="nc">TelescopeModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TelescopeModel represents the MC model of an individual telescope. It contains the list of \</span>
<span class="sd">    parameters that can be read from the DB. A set of methods are available to manipulate \</span>
<span class="sd">    parameters (changing, adding, removing etc).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    site: str</span>
<span class="sd">        South or North.</span>
<span class="sd">    telescope_model_name: str</span>
<span class="sd">        Telescope name (ex. LST-1, ...).</span>
<span class="sd">    mongo_db_config: dict</span>
<span class="sd">        MongoDB configuration.</span>
<span class="sd">    model_version: str</span>
<span class="sd">        Version of the model (ex. prod5).</span>
<span class="sd">    label: str</span>
<span class="sd">        Instance label. Important for output file naming.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TelescopeModel.__init__">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">site</span><span class="p">,</span>
        <span class="n">telescope_model_name</span><span class="p">,</span>
        <span class="n">mongo_db_config</span><span class="p">,</span>
        <span class="n">model_version</span><span class="o">=</span><span class="s2">&quot;Current&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize TelescopeModel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Init TelescopeModel&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">site</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">validate_site_name</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">validate_telescope_model_name</span><span class="p">(</span><span class="n">telescope_model_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_version</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">validate_model_version_name</span><span class="p">(</span><span class="n">model_version</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_added_parameter_files</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_single_mirror_list_file_paths</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simtel_config_writer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mirrors</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reference_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_derived</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">io_handler</span> <span class="o">=</span> <span class="n">io_handler</span><span class="o">.</span><span class="n">IOHandler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mongo_db_config</span> <span class="o">=</span> <span class="n">mongo_db_config</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_load_parameters_from_db</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_config_file_directory_and_name</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_config_file_up_to_date</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_exported_model_files_up_to_date</span> <span class="o">=</span> <span class="kc">False</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mirrors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the mirror information if the class instance hasn&#39;t done it yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mirrors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_mirrors</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mirrors</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">camera</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the camera information if the class instance hasn&#39;t done it yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_camera</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reference_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the reference data information if the class instance hasn&#39;t done it yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reference_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_reference_data</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reference_data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">derived</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the derived values and export them if the class instance hasn&#39;t done it yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derived</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_derived_values</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">export_derived_files</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derived</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">extra_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the extra label if defined, if not return &#39;&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_label</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

<div class="viewcode-block" id="TelescopeModel.from_config_file">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.from_config_file">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config_file_name</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">telescope_model_name</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a TelescopeModel from a sim_telarray config file.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Todo: Dealing with ifdef/indef etc. By now it just keeps the last version of the parameters</span>
<span class="sd">        in the file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        config_file_name: str or Path</span>
<span class="sd">            Path to the input config file.</span>
<span class="sd">        site: str</span>
<span class="sd">            South or North.</span>
<span class="sd">        telescope_model_name: str</span>
<span class="sd">            Telescope model name for the base set of parameters (ex. LST-1, ...).</span>
<span class="sd">        label: str</span>
<span class="sd">            Instance label. Important for output file naming.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        TelescopeModel</span>
<span class="sd">            Instance of TelescopeModel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tel</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">site</span><span class="o">=</span><span class="n">site</span><span class="p">,</span>
            <span class="n">telescope_model_name</span><span class="o">=</span><span class="n">telescope_model_name</span><span class="p">,</span>
            <span class="n">mongo_db_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">_process_line</span><span class="p">(</span><span class="n">words</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Process a line of the input config file that contains a parameter.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            words: list of str</span>
<span class="sd">                List of str from the split of a line from the file.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            (par_name, par_value)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">i_comment</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>  <span class="c1"># Index of any possible comment</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;%&quot;</span> <span class="ow">in</span> <span class="n">w</span><span class="p">:</span>
                    <span class="n">i_comment</span> <span class="o">=</span> <span class="n">words</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="n">words</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i_comment</span><span class="p">]</span>  <span class="c1"># Removing comment</span>
            <span class="n">par_name</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">par_value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="n">par_value</span> <span class="o">+=</span> <span class="n">w</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
            <span class="n">par_value</span> <span class="o">=</span> <span class="n">par_value</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>  <span class="c1"># Removing trailing spaces (left and right)</span>
            <span class="k">return</span> <span class="n">par_name</span><span class="p">,</span> <span class="n">par_value</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file_name</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="s2">&quot;%&quot;</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;echo&quot;</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">par</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">_process_line</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">for</span> <span class="n">par</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">tel</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">tel</span><span class="o">.</span><span class="n">_is_exported_model_files_up_to_date</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">tel</span></div>


<div class="viewcode-block" id="TelescopeModel.set_extra_label">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.set_extra_label">[docs]</a>
    <span class="k">def</span> <span class="nf">set_extra_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extra_label</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set an extra label for the name of the config file.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The config file directory name is not affected by the extra label. Only the file name is \</span>
<span class="sd">        changed. This is important for the ArrayModel class to export multiple config files in the\</span>
<span class="sd">        same directory.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        extra_label: str</span>
<span class="sd">            Extra label to be appended to the original label.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_label</span> <span class="o">=</span> <span class="n">extra_label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_config_file_directory_and_name</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_set_config_file_directory_and_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define the variable _config_file_directory and create directories, if needed.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config_file_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io_handler</span><span class="o">.</span><span class="n">get_output_directory</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">sub_dir</span><span class="o">=</span><span class="s2">&quot;model&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Setting file name and the location</span>
        <span class="n">config_file_name</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">simtel_telescope_config_file_name</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_version</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_label</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_file_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">config_file_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_parameters_from_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read parameters from DB and store them in _parameters.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mongo_db_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reading telescope parameters from DB&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_config_file_directory_and_name</span><span class="p">()</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">db_handler</span><span class="o">.</span><span class="n">DatabaseHandler</span><span class="p">(</span><span class="n">mongo_db_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mongo_db_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_model_parameters</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_version</span><span class="p">,</span> <span class="n">only_applicable</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reading site parameters from DB&quot;</span><span class="p">)</span>
        <span class="n">_site_pars</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_site_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_version</span><span class="p">,</span> <span class="n">only_applicable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_site_pars</span><span class="p">)</span>

<div class="viewcode-block" id="TelescopeModel.has_parameter">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.has_parameter">[docs]</a>
    <span class="k">def</span> <span class="nf">has_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify if the parameter is in the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        par_name: str</span>
<span class="sd">            Name of the parameter.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if parameter is in the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">par_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span></div>


<div class="viewcode-block" id="TelescopeModel.get_parameter">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.get_parameter">[docs]</a>
    <span class="k">def</span> <span class="nf">get_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get an existing parameter of the model, including derived parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        par_name: str</span>
<span class="sd">            Name of the parameter.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Value of the parameter</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        InvalidParameter</span>
<span class="sd">            If par_name does not match any parameter in this model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="n">par_name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># search in the derived parameters</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">derived</span><span class="p">[</span><span class="n">par_name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Parameter </span><span class="si">{</span><span class="n">par_name</span><span class="si">}</span><span class="s2"> was not found in the model&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span></div>


<div class="viewcode-block" id="TelescopeModel.get_parameter_value">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.get_parameter_value">[docs]</a>
    <span class="k">def</span> <span class="nf">get_parameter_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the value of an existing parameter of the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        par_name: str</span>
<span class="sd">            Name of the parameter.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Value of the parameter.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        InvalidParameter</span>
<span class="sd">            If par_name does not match any parameter in this model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">par_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">par_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">par_info</span><span class="p">[</span><span class="s2">&quot;Value&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="TelescopeModel.get_parameter_value_with_unit">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.get_parameter_value_with_unit">[docs]</a>
    <span class="k">def</span> <span class="nf">get_parameter_value_with_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the value of an existing parameter of the model as an Astropy Quantity with its unit.\</span>
<span class="sd">        If no unit is provided in the model, the value is returned without a unit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        par_name: str</span>
<span class="sd">            Name of the parameter.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Astropy quantity with the value of the parameter multiplied by its unit. If no unit is \</span>
<span class="sd">        provided in the model, the value is returned without a unit.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        InvalidParameter</span>
<span class="sd">            If par_name does not match any parameter in this model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">par_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">par_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;units&quot;</span> <span class="ow">in</span> <span class="n">par_info</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">par_info</span><span class="p">[</span><span class="s2">&quot;Value&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">par_info</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">par_info</span><span class="p">[</span><span class="s2">&quot;Value&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="TelescopeModel.add_parameter">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.add_parameter">[docs]</a>
    <span class="k">def</span> <span class="nf">add_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par_name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">is_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_aplicable</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a new parameters to the model. This function does not modify the DB, it affects only \</span>
<span class="sd">        the current instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        par_name: str</span>
<span class="sd">            Name of the parameter.</span>
<span class="sd">        value:</span>
<span class="sd">            Value of the parameter.</span>
<span class="sd">        is_file: bool</span>
<span class="sd">            Indicates whether the new parameter is a file or not.</span>
<span class="sd">        is_aplicable: bool</span>
<span class="sd">            Indicates whether the new parameter is applicable or not.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        InvalidParameter</span>
<span class="sd">            If an existing parameter is tried to be added.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">par_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Parameter </span><span class="si">{</span><span class="n">par_name</span><span class="si">}</span><span class="s2"> already in the model, use change_parameter instead&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="n">par_name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> to the model&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="n">par_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="n">par_name</span><span class="p">][</span><span class="s2">&quot;Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="n">par_name</span><span class="p">][</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="n">par_name</span><span class="p">][</span><span class="s2">&quot;Applicable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_aplicable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="n">par_name</span><span class="p">][</span><span class="s2">&quot;File&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_file</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_is_config_file_up_to_date</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">is_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_exported_model_files_up_to_date</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="TelescopeModel.change_parameter">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.change_parameter">[docs]</a>
    <span class="k">def</span> <span class="nf">change_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par_name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the value of an existing parameter to the model. This function does not modify the \</span>
<span class="sd">        DB, it affects only the current instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        par_name: str</span>
<span class="sd">            Name of the parameter.</span>
<span class="sd">        value:</span>
<span class="sd">            Value of the parameter.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        InvalidParameter</span>
<span class="sd">            If the parameter to be changed does not exist in this model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">par_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Parameter </span><span class="si">{</span><span class="n">par_name</span><span class="si">}</span><span class="s2"> not in the model, use add_parameters instead&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">type_of_par_name</span> <span class="o">=</span> <span class="n">locate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="n">par_name</span><span class="p">][</span><span class="s2">&quot;Type&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">type_of_par_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The type of the provided value (</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">) &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;is different from the type of </span><span class="si">{</span><span class="n">par_name</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="n">par_name</span><span class="p">][</span><span class="s1">&#39;Type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">). &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Attempting to cast to the correct type.&quot;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">type_of_par_name</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Could not cast </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="n">par_name</span><span class="p">][</span><span class="s1">&#39;Type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Changing parameter </span><span class="si">{</span><span class="n">par_name</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="n">par_name</span><span class="p">][</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="n">par_name</span><span class="p">][</span><span class="s2">&quot;Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># In case parameter is a file, the model files will be outdated</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="n">par_name</span><span class="p">][</span><span class="s2">&quot;File&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_exported_model_files_up_to_date</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_is_config_file_up_to_date</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="TelescopeModel.change_multiple_parameters">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.change_multiple_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">change_multiple_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the value of multiple existing parameters in the model. This function does not \</span>
<span class="sd">        modify the DB, it affects only the current instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Parameters should be passed as parameter_name=value.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        InvalidParameter</span>
<span class="sd">            If at least one of the parameters to be changed does not exist in this model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">par</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">par</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">change_parameter</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_is_config_file_up_to_date</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="TelescopeModel.remove_parameters">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.remove_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove a set of parameters from the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        *args</span>
<span class="sd">            Each parameter to be removed has to be passed as args.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        InvalidParameter</span>
<span class="sd">            If at least one of the parameter to be removed is not in this model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">par</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing parameter </span><span class="si">{</span><span class="n">par</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="n">par</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Could not remove parameter </span><span class="si">{</span><span class="n">par</span><span class="si">}</span><span class="s2"> because it does not exist&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_config_file_up_to_date</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="TelescopeModel.add_parameter_file">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.add_parameter_file">[docs]</a>
    <span class="k">def</span> <span class="nf">add_parameter_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par_name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a file to the config file directory.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        par_name: str</span>
<span class="sd">            Name of the parameter.</span>
<span class="sd">        file_path: str</span>
<span class="sd">            Path of the file to be added to the config file directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_added_parameter_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_added_parameter_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_added_parameter_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">par_name</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_file_directory</span><span class="p">)</span></div>


<div class="viewcode-block" id="TelescopeModel.export_model_files">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.export_model_files">[docs]</a>
    <span class="k">def</span> <span class="nf">export_model_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exports the model files into the config file directory.&quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">db_handler</span><span class="o">.</span><span class="n">DatabaseHandler</span><span class="p">(</span><span class="n">mongo_db_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mongo_db_config</span><span class="p">)</span>

        <span class="c1"># Removing parameter files added manually (which are not in DB)</span>
        <span class="n">pars_from_db</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_added_parameter_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_added_parameter_files</span><span class="p">:</span>
                <span class="n">pars_from_db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">par</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">export_model_files</span><span class="p">(</span><span class="n">pars_from_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_file_directory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_exported_model_files_up_to_date</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="TelescopeModel.print_parameters">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.print_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">print_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print parameters and their values for debugging purposes.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">par</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">par</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TelescopeModel.export_config_file">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.export_config_file">[docs]</a>
    <span class="k">def</span> <span class="nf">export_config_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Export the config file used by sim_telarray.&quot;&quot;&quot;</span>

        <span class="c1"># Exporting model file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_exported_model_files_up_to_date</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">export_model_files</span><span class="p">()</span>

        <span class="c1"># Using SimtelConfigWriter to write the config file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_simtel_config_writer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simtel_config_writer</span><span class="o">.</span><span class="n">write_telescope_config_file</span><span class="p">(</span>
            <span class="n">config_file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file_path</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TelescopeModel.export_derived_files">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.export_derived_files">[docs]</a>
    <span class="k">def</span> <span class="nf">export_derived_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write to disk a file from the derived values DB.&quot;&quot;&quot;</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">db_handler</span><span class="o">.</span><span class="n">DatabaseHandler</span><span class="p">(</span><span class="n">mongo_db_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mongo_db_config</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">par_now</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">derived</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">par_now</span><span class="p">[</span><span class="s2">&quot;File&quot;</span><span class="p">]:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">export_file_db</span><span class="p">(</span>
                    <span class="n">db_name</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">DB_DERIVED_VALUES</span><span class="p">,</span>
                    <span class="n">dest</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io_handler</span><span class="o">.</span><span class="n">get_output_directory</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">sub_dir</span><span class="o">=</span><span class="s2">&quot;derived&quot;</span><span class="p">),</span>
                    <span class="n">file_name</span><span class="o">=</span><span class="n">par_now</span><span class="p">[</span><span class="s2">&quot;Value&quot;</span><span class="p">],</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="TelescopeModel.get_config_file">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.get_config_file">[docs]</a>
    <span class="k">def</span> <span class="nf">get_config_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no_export</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the path of the config file for sim_telarray. The config file is produced if the file\</span>
<span class="sd">        is not updated.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        no_export: bool</span>
<span class="sd">            Turn it on if you do not want the file to be exported.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Path</span>
<span class="sd">            Path of the exported config file for sim_telarray.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_config_file_up_to_date</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">no_export</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">export_config_file</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_file_path</span></div>


<div class="viewcode-block" id="TelescopeModel.get_config_directory">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.get_config_directory">[docs]</a>
    <span class="k">def</span> <span class="nf">get_config_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the path where all the configuration files for sim_telarray are written to.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Path</span>
<span class="sd">            Path where all the configuration files for sim_telarray are written to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_file_directory</span></div>


<div class="viewcode-block" id="TelescopeModel.get_derived_directory">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.get_derived_directory">[docs]</a>
    <span class="k">def</span> <span class="nf">get_derived_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the path where all the files with derived values for are written to.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Path</span>
<span class="sd">            Path where all the files with derived values are written to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_file_directory</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;derived&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TelescopeModel.get_telescope_transmission_parameters">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.get_telescope_transmission_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">get_telescope_transmission_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get tel. transmission pars as a list of floats.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of floats</span>
<span class="sd">            List of 4 parameters that describe the tel. transmission vs off-axis.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">telescope_transmission</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter_value</span><span class="p">(</span><span class="s2">&quot;telescope_transmission&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">telescope_transmission</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter_value</span><span class="p">(</span><span class="s2">&quot;telescope_transmission&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>

        <span class="k">return</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">telescope_transmission</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="TelescopeModel.export_single_mirror_list_file">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.export_single_mirror_list_file">[docs]</a>
    <span class="k">def</span> <span class="nf">export_single_mirror_list_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mirror_number</span><span class="p">,</span> <span class="n">set_focal_length_to_zero</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export a mirror list file with a single mirror in it.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mirror_number: int</span>
<span class="sd">            Number index of the mirror.</span>
<span class="sd">        set_focal_length_to_zero: bool</span>
<span class="sd">            Set the focal length to zero if True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mirror_number</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mirrors</span><span class="o">.</span><span class="n">number_of_mirrors</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;mirror_number &gt; number_of_mirrors&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">file_name</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">simtel_single_mirror_list_file_name</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_version</span><span class="p">,</span> <span class="n">mirror_number</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_mirror_list_file_paths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_single_mirror_list_file_paths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_single_mirror_list_file_paths</span><span class="p">[</span><span class="n">mirror_number</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_file_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
            <span class="n">file_name</span>
        <span class="p">)</span>

        <span class="c1"># Using SimtelConfigWriter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_simtel_config_writer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simtel_config_writer</span><span class="o">.</span><span class="n">write_single_mirror_list_file</span><span class="p">(</span>
            <span class="n">mirror_number</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mirrors</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_single_mirror_list_file_paths</span><span class="p">[</span><span class="n">mirror_number</span><span class="p">],</span>
            <span class="n">set_focal_length_to_zero</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TelescopeModel.get_single_mirror_list_file">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.get_single_mirror_list_file">[docs]</a>
    <span class="k">def</span> <span class="nf">get_single_mirror_list_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mirror_number</span><span class="p">,</span> <span class="n">set_focal_length_to_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the path to the single mirror list file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mirror_number: int</span>
<span class="sd">            Mirror number.</span>
<span class="sd">        set_focal_length_to_zero: bool</span>
<span class="sd">            Flag to set the focal length to zero.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Path</span>
<span class="sd">            Path of the single mirror list file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_single_mirror_list_file</span><span class="p">(</span><span class="n">mirror_number</span><span class="p">,</span> <span class="n">set_focal_length_to_zero</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_mirror_list_file_paths</span><span class="p">[</span><span class="n">mirror_number</span><span class="p">]</span></div>


    <span class="k">def</span> <span class="nf">_load_mirrors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the attribute mirrors by creating a Mirrors object with the mirror list file.&quot;&quot;&quot;</span>
        <span class="n">mirror_list_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="s2">&quot;mirror_list&quot;</span><span class="p">][</span><span class="s2">&quot;Value&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mirror_list_file</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">find_file</span><span class="p">(</span><span class="n">mirror_list_file_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_file_directory</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">mirror_list_file</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">find_file</span><span class="p">(</span><span class="n">mirror_list_file_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">io_handler</span><span class="o">.</span><span class="n">model_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Mirror_list_file was not found in the config directory - &quot;</span>
                <span class="s2">&quot;Using the one found in the model_path&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mirrors</span> <span class="o">=</span> <span class="n">Mirrors</span><span class="p">(</span><span class="n">mirror_list_file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_reference_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the reference data for this telescope from the DB.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reading reference data from DB&quot;</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">db_handler</span><span class="o">.</span><span class="n">DatabaseHandler</span><span class="p">(</span><span class="n">mongo_db_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mongo_db_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reference_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_reference_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_version</span><span class="p">,</span> <span class="n">only_applicable</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_derived_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the derived values for this telescope from the DB.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reading derived data from DB&quot;</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">db_handler</span><span class="o">.</span><span class="n">DatabaseHandler</span><span class="p">(</span><span class="n">mongo_db_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mongo_db_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_derived</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_derived_values</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_version</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_camera</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loading camera attribute by creating a Camera object with the camera config file.&quot;&quot;&quot;</span>
        <span class="n">camera_config_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter_value</span><span class="p">(</span><span class="s2">&quot;camera_config_file&quot;</span><span class="p">)</span>
        <span class="n">focal_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter_value</span><span class="p">(</span><span class="s2">&quot;effective_focal_length&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">focal_length</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Using focal_length because effective_focal_length is 0.&quot;</span><span class="p">)</span>
            <span class="n">focal_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter_value</span><span class="p">(</span><span class="s2">&quot;focal_length&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">camera_config_file_path</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">find_file</span><span class="p">(</span><span class="n">camera_config_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_file_directory</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;The camera_config_file was not found in the config directory - &quot;</span>
                <span class="s2">&quot;Using the one found in the model_path&quot;</span>
            <span class="p">)</span>
            <span class="n">camera_config_file_path</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">find_file</span><span class="p">(</span><span class="n">camera_config_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">io_handler</span><span class="o">.</span><span class="n">model_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span> <span class="o">=</span> <span class="n">Camera</span><span class="p">(</span>
            <span class="n">telescope_model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">camera_config_file</span><span class="o">=</span><span class="n">camera_config_file_path</span><span class="p">,</span>
            <span class="n">focal_length</span><span class="o">=</span><span class="n">focal_length</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_simtel_config_writer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the SimtelConfigWriter object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simtel_config_writer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simtel_config_writer</span> <span class="o">=</span> <span class="n">SimtelConfigWriter</span><span class="p">(</span>
                <span class="n">site</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="p">,</span>
                <span class="n">telescope_model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">model_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_version</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
            <span class="p">)</span>

<div class="viewcode-block" id="TelescopeModel.is_file_2D">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.is_file_2D">[docs]</a>
    <span class="k">def</span> <span class="nf">is_file_2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the file referenced by par is a 2D table.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        par: str</span>
<span class="sd">            Name of the parameter.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool:</span>
<span class="sd">            True if the file is a 2D map type, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_parameter</span><span class="p">(</span><span class="n">par</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter </span><span class="si">{</span><span class="n">par</span><span class="si">}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter_value</span><span class="p">(</span><span class="n">par</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config_directory</span><span class="p">()</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">is2D</span> <span class="o">=</span> <span class="s2">&quot;@RPOL@&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">is2D</span></div>


<div class="viewcode-block" id="TelescopeModel.read_two_dim_wavelength_angle">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.read_two_dim_wavelength_angle">[docs]</a>
    <span class="k">def</span> <span class="nf">read_two_dim_wavelength_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read a two dimensional distribution of wavelngth and angle (z-axis can be anything). Return\</span>
<span class="sd">        a dictionary with three arrays, wavelength, angles, z (can be transmission, reflectivity,\</span>
<span class="sd">        etc.)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_name: str or Path</span>
<span class="sd">            File assumed to be in the model directory.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict:</span>
<span class="sd">            dict of three arrays, wavelength, degrees, z.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config_directory</span><span class="p">()</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="n">line_to_start_from</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i_line</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ANGLE&quot;</span><span class="p">):</span>
                    <span class="n">degrees</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
                    <span class="n">line_to_start_from</span> <span class="o">=</span> <span class="n">i_line</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">break</span>  <span class="c1"># The rest can be read with np.loadtxt</span>

        <span class="n">_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="n">line_to_start_from</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;Wavelength&quot;</span><span class="p">:</span> <span class="n">_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;Angle&quot;</span><span class="p">:</span> <span class="n">degrees</span><span class="p">,</span>
            <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="TelescopeModel.get_on_axis_eff_optical_area">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.get_on_axis_eff_optical_area">[docs]</a>
    <span class="k">def</span> <span class="nf">get_on_axis_eff_optical_area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the on-axis effective optical area (derived previously for this telescope).&quot;&quot;&quot;</span>

        <span class="n">ray_tracing_data</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_derived_directory</span><span class="p">()</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">derived</span><span class="p">[</span><span class="s2">&quot;ray_tracing&quot;</span><span class="p">][</span><span class="s2">&quot;Value&quot;</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">ray_tracing_data</span><span class="p">[</span><span class="s2">&quot;Off-axis angle&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No value for the on-axis effective optical area exists.&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; The minumum off-axis angle is </span><span class="si">{</span><span class="n">ray_tracing_data</span><span class="p">[</span><span class="s1">&#39;Off-axis angle&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">return</span> <span class="n">ray_tracing_data</span><span class="p">[</span><span class="s2">&quot;eff_area&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="TelescopeModel.read_incidence_angle_distribution">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.read_incidence_angle_distribution">[docs]</a>
    <span class="k">def</span> <span class="nf">read_incidence_angle_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">incidence_angle_dist_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the incidence angle distribution from a file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        incidence_angle_dist_file: str</span>
<span class="sd">            File name of the incidence angle distribution</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        incidence_angle_dist: astropy.table.Table</span>
<span class="sd">            Instance of astropy.table.Table with the incidence angle distribution.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">incidence_angle_dist</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_derived_directory</span><span class="p">()</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">incidence_angle_dist_file</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">incidence_angle_dist</span></div>


<div class="viewcode-block" id="TelescopeModel.calc_average_curve">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.calc_average_curve">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calc_average_curve</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span> <span class="n">incidence_angle_dist</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate an average curve from a set of curves, using as weights the distribution of \</span>
<span class="sd">        incidence angles provided in incidence_angle_dist.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        curves: dict</span>
<span class="sd">            dict of with 3 &quot;columns&quot;, Wavelength, Angle and z. The dictionary represents a two \</span>
<span class="sd">            dimensional distribution of wavelengths and angles with the z value being e.g., \</span>
<span class="sd">            reflectivity, transmission, etc.</span>
<span class="sd">        incidence_angle_dist: astropy.table.Table</span>
<span class="sd">            Instance of astropy.table.Table with the incidence angle distribution. The assumed \</span>
<span class="sd">            columns are &quot;Incidence angle&quot; and &quot;Fraction&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        average_curve: astropy.table.Table</span>
<span class="sd">            Instance of astropy.table.Table with the averaged curve.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">angle_now</span> <span class="ow">in</span> <span class="n">curves</span><span class="p">[</span><span class="s2">&quot;Angle&quot;</span><span class="p">]:</span>
            <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">incidence_angle_dist</span><span class="p">[</span><span class="s2">&quot;Fraction&quot;</span><span class="p">][</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">angle_now</span> <span class="o">-</span> <span class="n">incidence_angle_dist</span><span class="p">[</span><span class="s2">&quot;Incidence angle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
                <span class="p">]</span>
            <span class="p">)</span>

        <span class="n">average_curve</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
            <span class="p">[</span><span class="n">curves</span><span class="p">[</span><span class="s2">&quot;Wavelength&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">curves</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)],</span>
            <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Wavelength&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">average_curve</span></div>


<div class="viewcode-block" id="TelescopeModel.export_table_to_model_directory">
<a class="viewcode-back" href="../../mc_model.html#model.telescope_model.TelescopeModel.export_table_to_model_directory">[docs]</a>
    <span class="k">def</span> <span class="nf">export_table_to_model_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write out a file with the provided table to the model directory.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_name: str</span>
<span class="sd">            File name to write to.</span>
<span class="sd">        table: astropy.table.Table</span>
<span class="sd">            Instance of astropy.table.Table with the values to write to the file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Path:</span>
<span class="sd">            Path to the file exported.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">file_to_write_to</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_file_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_to_write_to</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;ascii.commented_header&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">file_to_write_to</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span></div>
</div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../simtools-configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../library.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../auxiliary_files.html">Auxiliary Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../databases.html">Databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../simulation_software.html">Simulation Software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guidelines.html">Developer Guidelines</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">simtools v0.1.dev1+g8f3402d Manual</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">model.telescope_model</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2022, gammasim-tools, simtools developers.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.4.
    </div>
  </body>
</html>