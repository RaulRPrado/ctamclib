<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Developer Guidelines &#8212; simtools v0.1.dev1+gc1b42a6</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=4f649999" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=28c8e701" />
    <link rel="stylesheet" type="text/css" href="_static/simtools.css" />
    <script src="_static/documentation_options.js?v=b8decdf8"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Pull requests" href="pull_requests.html" />
    <link rel="prev" title="Simulation Software" href="simulation_software.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">simtools</a></h1>



<p class="blurb">Simulation Tools for CTA v0.1.dev1+gc1b42a6</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=gammasim&repo=simtools&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="simtools-configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="library.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="auxiliary_files.html">Auxiliary Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="databases.html">Databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="simulation_software.html">Simulation Software</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Developer Guidelines</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#project-setup">Project setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#python-version">Python version</a></li>
<li class="toctree-l2"><a class="reference internal" href="#contributing-code">Contributing code</a></li>
<li class="toctree-l2"><a class="reference internal" href="#unit-and-integration-testing">Unit and Integration Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#generating-documentation">Generating Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#writing-applications">Writing Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="#integration-with-corsika-and-sim-telarray">Integration with CORSIKA and sim_telarray</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-files">Data files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#input-validation">Input validation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="pull_requests.html">Pull requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="coding_guidelines.html">Coding Guidelines</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="simulation_software.html" title="previous chapter">Simulation Software</a></li>
      <li>Next: <a href="pull_requests.html" title="next chapter">Pull requests</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/developer_guidelines.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="developer-guidelines">
<span id="guidelines"></span><h1>Developer Guidelines<a class="headerlink" href="#developer-guidelines" title="Link to this heading">¶</a></h1>
<p>This section provides guidelines for developers of simtools.</p>
<p>If you want to contribute, contact the simtools team using one of the contact points listed at the
entry page of this documentation.</p>
<p>Simtools follows generally the development guidelines of CTAO and
ctapipe (see <a class="reference external" href="https://ctapipe.readthedocs.io/en/latest/developer-guide/index.html">ctapipe development</a>).</p>
<section id="project-setup">
<h2>Project setup<a class="headerlink" href="#project-setup" title="Link to this heading">¶</a></h2>
<p>The main code repository for simtools is on GitHub:</p>
<p><a class="reference external" href="https://github.com/gammasim/simtools">https://github.com/gammasim/simtools</a></p>
<p>The main directories of simtools are:</p>
<ul class="simple">
<li><p>root directory: <a class="reference external" href="https://github.com/gammasim/simtools/tree/main/simtools">simtools</a></p></li>
<li><p>applications (simtools:) <a class="reference external" href="https://github.com/gammasim/simtools/tree/main/simtools/applications">simtools/applications</a></p></li>
<li><p>unit and integration tests: <a class="reference external" href="https://github.com/gammasim/simtools/tree/main/tests">./tests</a></p></li>
<li><p>documentation: <a class="reference external" href="https://github.com/gammasim/simtools/tree/main/docs">./docs</a></p></li>
<li><p>docker files: <a class="reference external" href="https://github.com/gammasim/simtools/tree/main/docker">.docker</a></p></li>
</ul>
</section>
<section id="python-version">
<h2>Python version<a class="headerlink" href="#python-version" title="Link to this heading">¶</a></h2>
<p>The simtools package is currently developed for Python &gt;=3.9.</p>
</section>
<section id="contributing-code">
<h2>Contributing code<a class="headerlink" href="#contributing-code" title="Link to this heading">¶</a></h2>
<p>It is recommended to discuss any code changes with the simtools team before starting to implement them
(e.g., by opening an issue on GitHub).</p>
<p>The following steps outline how to contribute code to simtools:</p>
<ol class="arabic simple">
<li><p>Set up your coding environment as outlined in the <a class="reference internal" href="getting_started.html#getting-started"><span class="std std-ref">getting started</span></a> section.</p></li>
<li><p>Start a new feature branch from the main branch (<code class="xref py py-obj docutils literal notranslate"><span class="pre">git</span> <span class="pre">checkout</span> <span class="pre">-b</span> <span class="pre">new-branch-name</span></code>).</p></li>
<li><p>Implement your code changes.</p></li>
<li><p>Add unit tests for new modules and functions.</p></li>
<li><p>Commit your code changes (use meaningful commit messages) and push them to GitHub.</p></li>
<li><p>Create a draft pull request on GitHub when all features are implemented.</p></li>
<li><p>Wait for the CI tests to finish and address any issues that arise.</p></li>
<li><p>After successful tests, mark the pull request as ready for review.</p></li>
<li><p>Wait for a review of your code and address any issues that arise.</p></li>
<li><p>After successful review, the pull request can be merged into the main branch.</p></li>
</ol>
<p>Note the <a class="reference internal" href="pull_requests.html#pull-requests"><span class="std std-ref">guidelines on pull requests</span></a>.</p>
</section>
<section id="unit-and-integration-testing">
<h2>Unit and Integration Testing<a class="headerlink" href="#unit-and-integration-testing" title="Link to this heading">¶</a></h2>
<p>The pytest framework is used for testing:</p>
<ul class="simple">
<li><p>unit tests should be written for every module and function</p></li>
<li><p>integration tests should be written for every application and cover the most important use cases. Integration tests should follow the logic of the existing tests in <a class="reference external" href="https://github.com/gammasim/simtools/tree/main/tests/integration_tests/">simtools/tests/integration_tests</a>.</p></li>
</ul>
<p>The test modules are located in
<a class="reference external" href="https://github.com/gammasim/simtools/tree/main/tests">simtools/tests</a> separated
by unit and integration tests.
It is recommended to write unit tests in parallel with the modules to assure that the code is testable.</p>
<p>General service functions for tests (e.g., DB connection) can be found in
<a class="reference external" href="https://github.com/gammasim/simtools/blob/main/tests/conftest.py">conftest.py</a>.
This should be used to avoid duplication.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Developers should expect that code changes affecting several modules are acceptable in case unit tests are successful.</p>
</div>
<p>The <a class="reference external" href="https://pytest-xdist.readthedocs.io/en/latest/">pytest-xdist</a> plugin is part of the developer environment
and can be used to run unit and integration tests in parallel (e.g., <code class="docutils literal notranslate"><span class="pre">pytest</span> <span class="pre">-n</span> <span class="pre">4</span></code> to run on four cores in parallel).</p>
<p>Tests might pass just because they run after an unrelated test. In order to test the independence of unit tests, use the
<a class="reference external" href="https://pypi.org/project/pytest-random-order/">pytest-random-order</a> plugin with <code class="docutils literal notranslate"><span class="pre">pytest</span> <span class="pre">--random-order</span></code>.</p>
<p>Check the test coverage with <code class="docutils literal notranslate"><span class="pre">pytest</span> <span class="pre">-vv</span> <span class="pre">-n</span> <span class="pre">auto</span> <span class="pre">tests/unit_tests/</span> <span class="pre">tests/integration_tests/</span> <span class="pre">--cov</span></code>.
Add the <code class="docutils literal notranslate"><span class="pre">--cov-report</span> <span class="pre">html</span></code> option to generate a coverage report in HTML format.</p>
</section>
<section id="generating-documentation">
<h2>Generating Documentation<a class="headerlink" href="#generating-documentation" title="Link to this heading">¶</a></h2>
<p>Sphinx is used to create this documentation from the files in the
<a class="reference external" href="https://github.com/gammasim/simtools/tree/main/docs">docs</a> directory and from the
docstrings in the code.</p>
<p>This is done automatically with each merge into the main branch, see the
<a class="reference external" href="https://github.com/gammasim/simtools/blob/main/.github/workflows/CI-docs.yml">GitHub Action workflow CI-docs</a>.</p>
<p>For writing and testing documentation locally:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">docs</span>
<span class="n">make</span> <span class="n">clean</span>
<span class="n">make</span> <span class="n">html</span>
</pre></div>
</div>
<p>This is especially recommended to identify warnings and errors by Sphinx (e.g., from badly formatted
docstrings or RST files). The documentation can be viewed locally in a browser starting from the
file <code class="docutils literal notranslate"><span class="pre">./build/html/index.html</span></code>.</p>
<p>The documentation is written in reStructuredText (RST) format.
Please make sure that you follow the RST format, as sphinx otherwise fails with error messages which are in some cases quite difficult to understand.</p>
<p>Hints:</p>
<ul class="simple">
<li><p>make sure that headings are underlined with the correct number of <code class="docutils literal notranslate"><span class="pre">=</span></code> characters</p></li>
<li><p>make sure that the indentation is correct and aligned</p></li>
<li><p>use unicode for special characters (e.g., <code class="docutils literal notranslate"><span class="pre">\u00B2</span></code> for superscript 2); see <a class="reference external" href="https://unicode-table.com/en/">unicode table</a></p></li>
</ul>
</section>
<section id="writing-applications">
<h2>Writing Applications<a class="headerlink" href="#writing-applications" title="Link to this heading">¶</a></h2>
<p>Applications are command lines tools that should be built of the simtools library.
Application should not include complex algorithm, this should be done at the module level.</p>
<p>All applications should follow the same structure:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="c1"># application name</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
    <span class="c1"># short description of the application</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;....&quot;</span>
    <span class="c1"># short help on how to use the application</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s2">&quot;.....&quot;</span>

    <span class="c1"># configuration handling (from command line, config file, etc)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="n">args_dict</span><span class="p">,</span> <span class="n">db_dict</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

    <span class="c1"># generic logger</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">get_log_level_from_user</span><span class="p">(</span><span class="n">args_dict</span><span class="p">[</span><span class="s2">&quot;log_level&quot;</span><span class="p">]))</span>

    <span class="c1"># application code follows</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Application handling should be done using the <a class="reference internal" href="configuration_module.html#configurationconfigurator"><span class="std std-ref">Configurator</span></a> class, which allows to set
configurations from command line, configuration file, or environmental variables.
Check the <a class="reference internal" href="configuration_module.html#configurationcommandline-parser"><span class="std std-ref">commandline_parser</span></a> module for generic command line arguments before introducing new ones in applications</p>
<p>The documentation of application uses the in-line doc string.</p>
<p>Adding an applications requires the following changes:</p>
<ul class="simple">
<li><p>add application code to the <a class="reference external" href="https://github.com/gammasim/simtools/tree/main/simtools/applications">simtools/applications</a></p></li>
<li><p>add integration tests to <a class="reference external" href="https://github.com/gammasim/simtools/tree/main/tests/integration_tests">tests/integration_tests</a></p></li>
<li><p>modify <a class="reference external" href="https://github.com/gammasim/simtools/blob/main/pyproject.toml">pyproject.toml file for pip</a> (replace “_” by “-” and add “simtools-” to the application name)</p></li>
<li><p>add application to documentation in <a class="reference external" href="https://github.com/gammasim/simtools/blob/main/docs/source/applications.rst">docs/sources/applications.rst</a></p></li>
</ul>
</section>
<section id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Link to this heading">¶</a></h2>
<p>Dependencies on external packages should be kept to a minimum.
Packages are listed twice:</p>
<ul class="simple">
<li><p>in the mamba/conda <a class="reference external" href="https://github.com/gammasim/simtools/blob/main/environment.yml">environment file</a></p></li>
<li><p>in the <a class="reference external" href="https://github.com/gammasim/simtools/blob/main/pyproject.toml">pyproject.toml file for pip</a></p></li>
</ul>
<p>Some of the packages installed are used for the development only and not needed for executing
simtools application (see the ordering in sections in pyproject.toml).</p>
</section>
<section id="integration-with-corsika-and-sim-telarray">
<h2>Integration with CORSIKA and sim_telarray<a class="headerlink" href="#integration-with-corsika-and-sim-telarray" title="Link to this heading">¶</a></h2>
<p>CORSIKA and sim_telarray are external tools to simtools.
Their integration should be
minimally coupled with the rest of the package. The modules that depend directly on these
tools should be connected to the rest of the package through interfaces. This way, it
will be easier to replace these tools in the future.</p>
<p>One example of this approach is
<a class="reference external" href="https://github.com/gammasim/simtools/blob/main/simtools/simulator.py">simulator module</a>,
which connects to the tools used to manage and run simulations.</p>
</section>
<section id="data-files">
<h2>Data files<a class="headerlink" href="#data-files" title="Link to this heading">¶</a></h2>
<p>Data files should be kept outside of the simtools repository with the exception of files required for units tests.
These files should be kept at minimum and are stored in the <a class="reference external" href="https://github.com/gammasim/simtools/tree/main/tests/resources">tests/resources</a> directory.</p>
<p>Data files required by integration tests are downloaded during testing from the simulation model database.</p>
<p>Some auxiliary files can be found in the
<a class="reference external" href="https://github.com/gammasim/simtools/tree/main/data">data directory</a>.
Note that this is under review and might go away in near future.</p>
</section>
<section id="input-validation">
<h2>Input validation<a class="headerlink" href="#input-validation" title="Link to this heading">¶</a></h2>
<p>Any configurable inputs (e.g. physical parameters) to modules
must have them validated. The validation assures that the units, type and
format are correct and also allow for default values.</p>
<p>The configurable input must be passed to classes through a dictionary or a yaml
file. In the case of a dictionary the parameter is generally called config_data, in the
case of a yaml file, config_file.</p>
<p>The function <a class="reference internal" href="utils.html#utilsgeneral"><span class="std std-ref">gen.collect_data_from_yaml_or_dict</span></a>
must be used to read these arguments. It identifies which case was given and
reads it accordingly, returning a dictionary. It also raises an exception in case none are
given and not allow_empty.</p>
<p>The validation of the input is done by the function gen.validate_config_data, which
receives the dictionary with the collected input and a parameter dictionary. The parameter
dictionary is read from a parameter yaml file in the data/parameters directory.
The file is read through the function io.get_data_file(“parameters”, filename)
(see data files section).</p>
<p>Parameter yaml files contain the list of parameters to be validated and its
properties. See an example below:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">zenith_angle</span><span class="p">:</span>
<span class="w">  </span><span class="nt">len</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="kt">!astropy.units.Unit</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="nv">deg</span><span class="p p-Indicator">}</span>
<span class="w">  </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="kt">!astropy.units.Quantity</span>
<span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span>
<span class="w">    </span><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="kt">!astropy.units.Unit</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="nv">deg</span><span class="p p-Indicator">}</span>
<span class="w">  </span><span class="nt">names</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;zenith&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;theta&#39;</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>len gives the length of the input. If null, any len is accepted.</p></li>
<li><p>unit is the astropy unit</p></li>
<li><p>default must have the same len</p></li>
<li><p>names is a list of acceptable input names. The key in the returned dict will have the name given at the definition of the block (zenith_angle in this example)</p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      
      
      
      <a href="_sources/developer_guidelines.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>